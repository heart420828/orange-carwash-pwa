<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>橙式洗車工坊｜PWA（OCR 加強版）</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#ff8c32">
<style>
  :root { --brand:#ff8c32; --bg:#fff7ec; }
  *{box-sizing:border-box;}
  body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans TC","PingFang TC","Helvetica Neue",Arial,"Microsoft JhengHei",sans-serif;background:var(--bg);color:#222;}
  header{padding:16px;background:#ffe8d0;position:sticky;top:0;z-index:2;border-bottom:1px solid #f0d5b8;}
  h1{margin:0;font-size:20px;color:#c7601a;text-align:center;}
  main{max-width:720px;margin:0 auto;padding:16px;}
  .card{background:#fff;border-radius:12px;box-shadow:0 6px 20px rgba(0,0,0,.06);padding:16px;margin:16px 0;}
  .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap;}
  .row>label{min-width:90px;color:#444;}
  input[type="text"],input[type="date"],textarea,select{width:100%;padding:12px;border:1px solid #ddd;border-radius:10px;background:#fff;}
  textarea{min-height:72px;resize:vertical;}
  .btn{appearance:none;border:none;background:var(--brand);color:#000;font-weight:700;padding:12px 16px;border-radius:12px;cursor:pointer;box-shadow:0 4px 10px rgba(0,0,0,.1);}
  .btn.secondary{background:#ffd9b3;}
  .btn.ghost{background:#fff;border:1px solid #eee;}
  small.muted{color:#666;}
  video,canvas,img.preview{width:100%;border-radius:12px;background:#000;max-height:320px;object-fit:contain;}
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px;border-bottom:1px solid #eee;font-size:14px;text-align:left;}
</style>
<script>
if('serviceWorker' in navigator){ navigator.serviceWorker.register('./sw.js'); }
</script>
</head>
<body>
<header><h1>橙式洗車工坊｜PWA（OCR 加強版）</h1></header>
<main>

  <section class="card">
    <h2>拍照 / 相簿辨識</h2>
    <div class="row">
      <button id="btnOpenCamera" class="btn">開啟相機</button>
      <button id="btnSnap" class="btn secondary" disabled>拍照並辨識車牌</button>
      <button id="btnStop" class="btn ghost" disabled>關閉相機</button>
      <input id="filePicker" type="file" accept="image/*" style="display:none">
      <button id="btnPick" class="btn ghost">從相簿選擇照片</button>
    </div>
    <div style="margin-top:10px;">
      <video id="video" playsinline muted></video>
      <canvas id="canvas" style="display:none;"></canvas>
    </div>
    <small class="muted">⭐ 提升成功率：車牌置中、光線充足、避免斜角與反光。相簿清晰照成功率更高。</small>

    <div class="row" style="margin-top:12px;">
      <label>車牌</label>
      <input id="plate" type="text" placeholder="自動辨識或手動輸入，例如 ABC-1234">
    </div>
    <div class="row" style="margin-top:12px;">
      <label>日期</label>
      <input id="date" type="date">
    </div>
  </section>

  <section class="card">
    <h2>今天做的項目</h2>
    <div id="services" class="row"></div>
    <small class="muted">回保週期以所選項目的「最短天數」計算。</small>
    <div class="row" style="margin-top:12px;">
      <label>備註</label>
      <textarea id="notes" placeholder="可留空"></textarea>
    </div>
    <div class="row" style="margin-top:12px;">
      <label>下次回保</label>
      <input id="due" type="text" disabled placeholder="會自動計算">
    </div>
    <div class="row" style="margin-top:12px;">
      <button id="btnSave" class="btn">儲存</button>
      <button id="btnClear" class="btn ghost">清空</button>
    </div>
  </section>

  <section class="card">
    <h2>紀錄列表</h2>
    <table>
      <thead><tr><th>車牌</th><th>日期</th><th>項目</th><th>備註</th><th>到期日</th></tr></thead>
      <tbody id="list"></tbody>
    </table>
  </section>
</main>

<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
<script>
/* === 業務邏輯 === */
const SERVICES = ['洗車','維護劑','漆面鍍膜','玻璃鍍膜','內裝清潔','引擎室清潔','臭氧/除味','其他'];
const DEFAULT_CYCLES = {'洗車':30,'維護劑':30,'漆面鍍膜':90,'玻璃鍍膜':180,'內裝清潔':60,'引擎室清潔':90,'臭氧/除味':30,'其他':30};
let cycles = JSON.parse(localStorage.getItem('cycles')||'null')||DEFAULT_CYCLES;
let records = JSON.parse(localStorage.getItem('records')||'[]');
const el=id=>document.getElementById(id);
const $video=el('video'), $canvas=el('canvas'); let stream=null; let selected=new Set();

function initServices(){
  const box=el('services'); box.innerHTML='';
  SERVICES.forEach(s=>{
    const b=document.createElement('button'); b.className='btn ghost'; b.textContent=s;
    b.onclick=()=>{ if(selected.has(s)){selected.delete(s); b.className='btn ghost';}else{selected.add(s); b.className='btn secondary';} updateDuePreview(); };
    box.appendChild(b);
  });
}
function formatDate(d){const y=d.getFullYear();const m=String(d.getMonth()+1).padStart(2,'0');const da=String(d.getDate()).padStart(2,'0');return `${y}/${m}/${da}`;}
function updateDuePreview(){
  const ds=el('date').value; if(!ds){el('due').value='';return;}
  const base=new Date(ds); let days=selected.size?Math.min(...Array.from(selected).map(s=>cycles[s]||30)):30;
  const due=new Date(base.getTime()+days*86400000); el('due').value=formatDate(due);
}
function refreshList(){
  const tb=el('list'); tb.innerHTML=''; records.forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${r.plate}</td><td>${r.date}</td><td>${r.services.join('、')}</td><td>${r.notes||''}</td><td>${r.dueDate}</td>`;
    tb.appendChild(tr);
  });
}

/* === 台灣車牌：清理 + 正規化 === */
function postProcessPlate(raw){
  if(!raw) return '';
  raw = raw.toUpperCase().replace(/\s+/g,'');
  // 常見誤判修正
  raw = raw.replace(/O/g,'0').replace(/I/g,'1').replace(/Z/g,'2').replace(/S/g,'5').replace(/B/g,'8');
  // 支援多種樣式
  const patterns = [
    /([A-Z]{3}-?\d{4})/,        // ABC-1234
    /([A-Z]{2}-?\d{3,4})/,      // AB-1234 / AB-123
    /(\d{3}-?[A-Z]{3})/,        // 123-ABC
    /([A-Z]\d{3}-?[A-Z]{2})/    // A123-BC（少見）
  ];
  for(const re of patterns){
    const m = raw.match(re);
    if(m){
      let p = m[1].replace('-','');
      if(/^[A-Z]{3}\d{4}$/.test(p)) return p.slice(0,3)+'-'+p.slice(3);
      if(/^\d{3}[A-Z]{3}$/.test(p)) return p.slice(0,3)+'-'+p.slice(3);
      if(/^[A-Z]{2}\d{3,4}$/.test(p)) return p.slice(0,2)+'-'+p.slice(2);
      return p;
    }
  }
  return raw;
}

/* === 影像前處理 + OCR === */
async function ocrImageDataURL(dataUrl){
  const img=new Image(); img.src=dataUrl; await img.decode();
  const w=img.naturalWidth, h=img.naturalHeight;

  // 放大 1.2~1.8x，提升辨識
  const scale = Math.min(1.8, Math.max(1.2, 1200/Math.min(w,h)));
  const cw=Math.round(w*scale), ch=Math.round(h*scale);

  const c=document.createElement('canvas'); c.width=cw; c.height=ch;
  const ctx=c.getContext('2d');

  // 強化影像：對比/亮度/飽和
  ctx.filter='contrast(160%) brightness(115%) saturate(110%)';
  ctx.drawImage(img,0,0,cw,ch);

  // 轉灰階 + 二值化
  const imgd=ctx.getImageData(0,0,cw,ch); const d=imgd.data;
  for(let i=0;i<d.length;i+=4){
    const g = (d[i]*0.299 + d[i+1]*0.587 + d[i+2]*0.114)|0;
    const b = g>140?255:0; d[i]=d[i+1]=d[i+2]=b;
  }
  ctx.putImageData(imgd,0,0);

  const enhanced = c.toDataURL('image/png');

  // psm 7: 單行文字；白名單只允許字母數字與-
  const result = await Tesseract.recognize(enhanced,'eng',{
    tessedit_char_whitelist:'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789-',
    tessedit_pageseg_mode:7
  });
  return postProcessPlate(result?.data?.text||'');
}

/* === 相機 / 相簿流程 === */
async function openCamera(){
  if(location.protocol!=='https:' && location.hostname!=='localhost'){
    alert('iPhone 上要使用相機需 HTTPS 網址'); return;
  }
  if(stream) return;
  stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}});
  $video.srcObject=stream; await $video.play();
  el('btnSnap').disabled=false; el('btnStop').disabled=false;
}
function stopCamera(){
  if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; }
  $video.pause(); $video.srcObject=null; el('btnSnap').disabled=true; el('btnStop').disabled=true;
}
async function snap(){
  if(!stream) return;
  const W=$video.videoWidth, H=$video.videoHeight;
  $canvas.width=W; $canvas.height=H;
  const ctx=$canvas.getContext('2d');
  ctx.filter='contrast(160%) brightness(115%) saturate(110%)';
  ctx.drawImage($video,0,0,W,H);
  el('btnSnap').disabled=true; el('btnSnap').textContent='辨識中…';
  try{
    const dataUrl=$canvas.toDataURL('image/jpeg',0.92);
    const plate=await ocrImageDataURL(dataUrl);
    el('plate').value=plate||'';
  }catch(e){ console.error(e); alert('辨識失敗，請再試一次或改用相簿照片/手動輸入'); }
  finally{ el('btnSnap').disabled=false; el('btnSnap').textContent='拍照並辨識車牌'; }
}
async function pickFile(){
  const f=el('filePicker').files?.[0]; if(!f) return;
  const reader=new FileReader();
  reader.onload=async()=>{ 
    try{ el('plate').value = await ocrImageDataURL(reader.result.toString()) || ''; }
    catch(e){ alert('辨識失敗，請換一張更清晰的照片'); }
    finally{ el('filePicker').value=''; }
  };
  reader.readAsDataURL(f);
}

/* === 儲存 === */
function saveRecord(){
  const plate=el('plate').value.trim().toUpperCase();
  const ds=el('date').value; if(!ds){alert('請選擇日期');return;}
  const base=new Date(ds);
  const list=Array.from(selected);
  const days=list.length?Math.min(...list.map(s=>cycles[s]||30)):30;
  const due=new Date(base.getTime()+days*86400000);
  const rec={plate,date:formatDate(base),services:list,notes:el('notes').value.trim()||null,dueDate:formatDate(due)};
  records.unshift(rec); localStorage.setItem('records',JSON.stringify(records));
  refreshList(); alert('已儲存 ✅');
}

/* === 初始化 === */
window.addEventListener('load',()=>{
  initServices(); refreshList();
  const today=new Date(); const y=today.getFullYear(); const m=String(today.getMonth()+1).padStart(2,'0'); const d=String(today.getDate()).padStart(2,'0');
  el('date').value=`${y}-${m}-${d}`; updateDuePreview();

  el('btnOpenCamera').onclick=openCamera;
  el('btnStop').onclick=stopCamera;
  el('btnSnap').onclick=snap;
  el('btnPick').onclick=()=>el('filePicker').click();
  el('filePicker').addEventListener('change',pickFile);
  el('btnClear').onclick=()=>{ el('plate').value=''; selected.clear(); initServices(); el('notes').value=''; updateDuePreview(); };
  el('date').addEventListener('change',updateDuePreview);
  el('btnSave').onclick=saveRecord;
});
</script>
</body>
</html>
